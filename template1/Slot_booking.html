{%load static%}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'Slot_booking.css' %}">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <title>Slot Booking</title>
    {% load livereload_tags %}

    {% livereload_script %}
</head>
<body>
    <section class="pre-hm">

        <nav class="tumu">
      
          <div class="LOGO">
      
            <img src="{%static 'PRFT-img-logo.png'%}" alt="Perficient" style="width: 50px; height:50px; padding:5px; background:white; border-radius:2px ;">
    
      
        </div>
      
          <div class="navigation">  
      
           <ul>
           
            <li><a class="hme" href="{% url 'index' %}">HOME</a></li>
            <li><a class="abt" href="{% url 'about' %}">ABOUT</a></li>
              
            {%if user.is_authenticated %}

            <li>Hello, {{user.first_name}}</li>
            <!-- <li><a class="lgn" href="{% url 'logout' %}" >LOGOUT</a></li> -->
            <li class="profile-icon" id="profile-icon">
                <a href="#" title="user Profile">
                    <img src="{% static 'user-icon.png' %}" alt="user Profile">
                </a>
                <div id="profile-dropdown"  class="dropdown-menu" style="display: none;">
                    <ul class="ddm-dis" >
                        <li><a href="{%url 'booking_history' %}" title="booking History">Booking History</a></li>
                        <li><a href="{%url 'user_bookings' %}" title="my Bookings">Active Bookings</a></li>
                        <li><a href="{%url 'logout'%}" title="logout">Logout</a></li>
                    </ul>
                </div>
            </li>
            {%endif%}
     
          </ul>
      
          </div>
      
        </nav>
      
        </section>

    <div class="container available_slots">
        <h1>Available Slots</h1>

        <small>(Please select date and shift to preveiw/make your bookings.The shift timings are Shift-1:(9:30 to 17:30) and shift-2:(18:00 to 02:00))</small><br><br>

        <div class="row datesearch">

          <form  id="search_slot" method="get">
            {%csrf_token%}
  
          <div class="col-4 dateblock">  
  
              <label class="datename" for="selected-date"><b>Date</b></label>
  
              <input type="date" class="dateinput" id="selected-date" name="selected_date" min=""  required>

              <select class="Shift" name="selected_shift" id="P_shifts">
                <option value="1">Shift-1</option>
                <option value="2">Shift-2</option>
                
              </select>

              <!-- <input onclick="submit_by_id()"  type="submit" class="submitbutton"> -->
              <button  class="Show_slots_btn" onclick="submit_by_id()"  type="submit">Show Slots</button>
              
          </div>  
  
        </form>

      </div>

         <div class="slots" style=" justify-content: space-around;
         margin: 60px;" >
           
        </div>
        <div id="Book_slots_btn" style="display: none;">

            <ul class="required">

                <div class="slot1">
            
                    <li>
            
                        <div class="slot ">
        
                            <div class="space na"></div>
            
                            <medium>Avaliable</medium>
            
                        </div>
            
                    </li>
            
                    <li>
            
                        <div class="slot occupied">
            
                            <div class="space occupied"></div>
            
                            <medium>Occupied</medium>
            
                        </div>
            
                    </li>
            
                    <li>
            
                        <div class="slot selected">
            
                            <div class="space selected"></div>
            
                            <medium>Selected</medium>
            
                        </div>
            
                    </li>
            
                </div>
            
            </ul>




        <form action="" method="post">
            {%csrf_token%}

        <button class="Book_slots_btn" type="submit"  >Book Slots</button>
    </form>
</div>
    </div>
        <footer class="foot" id="foot1">

            <div class="container">
          
              <div class="contact-details">
          
                <h3>Contact Us</h3>
          
                <p>Email: example@email.com</p>
          
                <p>Phone: +1 (123) 456-7890</p>
          
                <p>Address: 123 Street, City, Country</p>
          
              </div>
          
              <div class="social-icons">
          
                <h3>Follow Us</h3>
          
                <ul>
          
                  <li><a href="#"><i class="fab fa-facebook"></i></a></li>
          
                  <li><a href="#"><i class="fab fa-twitter"></i></a></li>
          
                  <li><a href="#"><i class="fab fa-instagram"></i></a></li>
          
                  <!-- Add more social media icons as needed -->
             </ul>
          
              </div>
          
            </div>
          
           
          
          </footer>
    
   

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script>

    
        var datePicker = document.getElementById('selected-date');
        var slotsContainer = document.querySelector('.slots');
        var selectedSlot = null;
        var show_bookslot=document.getElementById('Book_slots_btn');
        var shiftDropdown = document.getElementById('P_shifts');
        
        var today = new Date().toISOString().split('T')[0];
        datePicker.min = today;
    
        function validation() {
            var date = datePicker.value;
            if (date === '') {
                alert("Please select a date");
                return false;
            } else {
                return true;
            }
        }
    
        function fetchSlots(selectedDate,selectedshift) {
            
            $.ajax({
                url: "{% url 'get_slots' %}",
                method: "GET",
                data: { selected_date: selectedDate,selected_shift:selectedshift },
                success: function (data) {
                    
                    slotsContainer.innerHTML = '';

                    data.slots.sort(function (a, b) {
                        return a.slot_number - b.slot_number;
                    });
    
                    
                    data.slots.forEach(function (slot) {
                        var slotElement = document.createElement('div');
                        slotElement.className = "slot";
                        slotElement.innerHTML = `
                            <button
                                class="slot-button ${slot.is_selected ? 'selected' : slot.is_available ? 'available' : 'occupied'}"
                                data-slotid="${slot.id}"
                                ${slot.is_selected || !slot.is_available ? 'disabled' : ''}
                                style="height: 100px; width: 100px;"
                            >
                            ${slot.slot_number} 
                            </button>
                           

                        `;
                        
                        slotElement.querySelector('.slot-button').addEventListener('click', function () {
                            toggleSlot(this);
                        });
    
                        slotsContainer.appendChild(slotElement);
                        //slots.sort();
                    });
                },
                error: function () {
                    alert("An error occurred while fetching slots.");
                },
            });
        }
    
        function toggleSlot(slotButton) {
            // Check if the slot is not occupied and not already selected
            if (!slotButton.classList.contains('occupied') && !slotButton.classList.contains('selected')) {
                if (selectedSlot) {
                    // Deselect the previously selected slot
                    selectedSlot.classList.remove('selected');
                }
                // Select the clicked slot
                slotButton.classList.add('selected');
                selectedSlot = slotButton;
            } else if (slotButton.classList.contains('selected')) {
                // Deselect the clicked slot
                slotButton.classList.remove('selected');
                selectedSlot = null;
            }
        }


        function show_book(){
            show_bookslot.style.cssText="display:block;text-align:center;margin-left:0px; padding:15px;";
        }



        function submit_by_id() {
            var date = datePicker.value;
            var shift = shiftDropdown.value;
            if (validation()) {
                
                fetchSlots(date,shift);
                show_book();
            }
            event.preventDefault();
        }



    
        var csrfToken = "{{ csrf_token }}";
                       
            document.getElementById('Book_slots_btn').addEventListener('click', function () {
                if (selectedSlot) {
                    var slotId = selectedSlot.getAttribute('data-slotid');
                    $.ajax({
                        url: "{% url 'book_slot' %}",
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrfToken,
                        },
                        data: { slotid: slotId },
                        success: function (data) {
                            console.log("3");
                            if (data.message === "Slot booked successfully.") {
                                console.log("cvacv");
                                selectedSlot.classList.add('occupied');
                                selectedSlot.classList.remove('available', 'selected');
                                selectedSlot.disabled = true;

                                alert(data.message);
                            window.location.href='{%url "index" %}';  
                            }
                             if(data.message === "You have already booked a slot for this date."){
                                alert(data.message);
                            }
                             
                            //window.history.back();                    
                         },
                        error: function () {
                            alert("You have already booked a slot for this date.");
                        },
                    });
                } else {
                    alert("Please  select a slot before booking.");
                }
                // Prevent the default form submission
                event.preventDefault();
            });
        
            $(document).ready(function() {
                console.log("Click event listener is active."); 
              
                
                function hideDropdown() {
                    console.log("Clicked or scrolled"); 
                    $(".dropdown-menu").hide();
                }
              
                
                $(".profile-icon").click(function(event) {
                    event.stopPropagation(); 
                    console.log("Clicked"); 
                    
                    $(".dropdown-menu").toggle();
                });
              
                
                $(document).click(function() {
                    hideDropdown();
                });
              
                
                $(window).scroll(function() {
                    hideDropdown();
                });
            });
              
</script>

</body>
</html>